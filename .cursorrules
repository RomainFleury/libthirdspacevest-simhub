# Third Space Vest Project - Cursor Rules

## Project Overview

This is a Third Space Vest haptic device debugger. It maintains legacy driver code untouched while building modern Python tooling and an Electron UI around it.

## Critical Constraints

- **NEVER modify** `legacy-do-not-change/` - This is historical code that must remain untouched
- **Isolation principle**: `vest/` package must stay isolated from game integrations
- **Daemon-centric**: All vest commands should go through the daemon (TCP port 5050)

## Architecture

```
Electron UI ──┐
Game Mods ────┼── TCP (5050) ──► Python Daemon ──► vest/ ──► USB Hardware
CS2 GSI ──────┘
```

## Quick Reference

### Start Development

```bash
python3 -m modern_third_space.cli daemon start  # Required first!
cd web && yarn dev                               # Start Electron
```

### Key Directories

- `modern-third-space/src/modern_third_space/vest/` - Hardware control (isolated)
- `modern-third-space/src/modern_third_space/server/` - TCP daemon
- `modern-third-space/src/modern_third_space/integrations/` - Game integrations
- `web/electron/` - Electron main process
- `web/src/` - React UI

### Adding Features

- **New daemon command**: Add to `server/protocol.py` + handler in `server/daemon.py`
- **New game integration**: See checklist below
- **New UI feature**: Add component in `web/src/components/`

### Adding Game Integrations (REQUIRED CHECKLIST)

**Before starting**, run existing tests to ensure clean baseline:
```bash
cd modern-third-space && python3 -m pytest tests/test_game_integrations.py -v
```

**Required steps for new game integrations:**

1. **Register in Registry** - Add to `integrations/registry.py`:
   - Create `GameIntegrationSpec` with all required fields
   - Call `register_integration()` to add to registry

2. **Create Manager** - Add `server/{game}_manager.py` with:
   - Manager class with `start()/stop()` for log watchers OR `process_event()` for TCP handlers
   - Callback setters for event broadcasting
   - Haptic mapping logic (via `map_event_to_haptics()` or `_trigger_*` methods)
   - Import from `vest.cell_layout` for cell constants

3. **Update Snapshot Test** - Add to `tests/test_game_integrations.py`:
   - Add entry in `EXPECTED_INTEGRATIONS` dict in `TestIntegrationSnapshot`

4. **Run Tests** - Must all pass:
   ```bash
   python3 -m pytest tests/test_game_integrations.py -v
   ```

**Pattern reference**: See `alyx_manager.py` for log watchers, `gtav_manager.py` for TCP handlers.

### Testing

See `modern-third-space/TESTING.md` for curl examples and test scripts.

**⚠️ MANDATORY: Run game integration tests before adding new integrations:**

```bash
cd modern-third-space
pip install -e .  # If not already installed
python3 -m pytest tests/test_game_integrations.py -v
```

All 27 tests must pass. The test suite validates:
- Integration registry consistency
- Manager class structure
- Haptic mapping patterns
- Cell layout usage
- Snapshot protection for existing integrations

## Documentation to Read First

1. `AI_ONBOARDING.md` - Full project context
2. `docs-external-integrations-ideas/DAEMON_ARCHITECTURE.md` - Daemon protocol
3. `docs-external-integrations-ideas/CS2_INTEGRATION.md` - Game integration example

## Code Style

- Python: Use type hints, dataclasses, asyncio for daemon code
- TypeScript: Follow existing patterns in `web/src/`
- Keep functions small and focused
- Add docstrings to new modules

## Common Patterns

### Daemon Command Handler

```python
async def _cmd_example(self, command: Command, client_id: str) -> Response:
    """Handle example command."""
    # Do something
    self._broadcast_event(EventType.EXAMPLE, {"data": "value"})
    return response_ok(command.req_id)
```

### Game Integration Event

```python
async def _handle_game_event(self, event_type: str, data: dict):
    if some_condition:
        await self.daemon.send_trigger(cell=0, speed=5)
        self.emit_event("event_name", {"info": "value"})
```
